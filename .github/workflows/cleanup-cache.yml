name: Cleanup Old Caches

on:
  schedule:
    - cron: "0 0 1 * *" # æ¯æœˆ1è™Ÿé‹è¡Œ
  workflow_dispatch: # å¯ä»¥æ‰‹å‹•åŸ·è¡Œæ­¤ action

permissions: write-all

jobs:
  cleanup-cashes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: è¨­å®šæœªä½¿ç”¨é€¾æœŸå¤©æ•¸
        id: set-days
        env:
          DAYS: 7
        run: |
          seconds=60   #$((60*60*24*DAYS))
          echo "ğŸ–Šï¸ $DAYSå¤©($secondsç§’)"
          echo "seconds=$seconds" >> $GITHUB_OUTPUT

      - name: å–å¾—é€¾æœŸ Caches ID
        id: list-caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh cache list --limit 100 --json id,createdAt,lastAccessedAt --jq 'sort_by(.lastAccessedAt) | .[] | {id, createdAt, lastAccessedAt}'
          cache_ids=$(gh cache list --limit 100 --json id,lastAccessedAt --jq '
                        sort_by(.lastAccessedAt) 
                        | .[] 
                        | select(.createdAt != null and .lastAccessedAt != null)
                        | select(
                            (.lastAccessedAt | fromdate) - (.createdAt | fromdate) > ${{ steps.set-days.outputs.seconds }}
                                )
                        | .id')
          echo "cache_ids=$cache_ids" >> $GITHUB_OUTPUT

      # (now - ( .lastAccessedAt | sub("\\..*Z$"; "Z") | fromdate )) > ${{ steps.set-days.outputs.seconds }})

      - name: åˆªé™¤é€¾æœŸ Caches
        if: steps.list-caches.outputs.cache_ids != ''
        run: |
          cnt=0
          for cache_id in ${{ steps.list-caches.outputs.cache_ids }}
          do
            gh cache delete $cache_id
            cnt=$((cnt+1))
          done
          echo "âœ… åˆªé™¤å®Œæˆï¼Œå…± $cnt ç­† Caches"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
