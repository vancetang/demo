name: Cleanup Old Caches

on:
  schedule:
    - cron: "0 0 1 * *" # 每月1號運行
  workflow_dispatch: # 可以手動執行此 action

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 設定逾期天數
        id: set-days
        env:
          DAYS: 30
        run: |
          seconds=60
          echo "$DAYS天($seconds秒)"
          echo "seconds=$seconds" >> $GITHUB_OUTPUT

      # seconds=$((60*60*24*DAYS))

      - name: List Caches
        id: list-caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh cache list --limit 100 --json id,createdAt 
          echo "----------------------------------------"
          gh cache list --limit 100 --json id,createdAt --jq '.[] | select((now | fromdateiso8601) - (.createdAt | fromdateiso8601) > ${{ steps.set-days.outputs.seconds }}) | .id'

      # cache_ids=$(gh cache list --limit 100 --json id,createdAt --jq '.[] | select(.createdAt < (now - ${{ steps.set-days.outputs.seconds }})) | .id')
      # echo "cache_ids=$cache_ids" >> $GITHUB_OUTPUT

      - name: Show Cache IDs
        run: echo "${{ steps.list-caches.outputs.cache_ids }}"

      # - name: Delete old caches
      #   if: steps.list-caches.outputs.cache-ids != ''
      #   run: |
      #     echo "📢 開始刪除 -----------"
      #     for cache_id in ${{ steps.list-caches.outputs.cache-ids }}
      #     do
      #       gh cache delete $cache_id
      #     done
      #     echo "✅ 刪除完成 -----------"
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# gh cache list --limit 100 --json id,createdAt --jq '.[] | select(.createdAt < now - $seconds) | .id'

