name: 新增或更新 Labels

on:
  workflow_dispatch: # 允許手動觸發

permissions:
  contents: write
  issues: write

jobs:
  add-labels:
    runs-on: ubuntu-latest
    steps:
      - name: 使用 GitHub API 新增或更新 Labels
        run: |
          LABELS=(
            '{"name": "feature", "color": "dac387", "description": "New Feature Request"}'
            '{"name": "testing", "color": "f9d0c4", "description": "Used to mark features that need testing or are currently being tested"}'
            '{"name": "wip", "color": "f4a261", "description": "Work in Progress"}'
            '{"name": "enhancement", "color": "a2eeef", "description": "Feature request or improvement suggestion to enhance the functionality"}'
          )

          echo "======= Adding or updating labels to ${{ github.repository }} ======="

          for LABEL in "${LABELS[@]}"; do
            LABEL_NAME=$(echo $LABEL | jq -r '.name')
            LABEL_COLOR=$(echo $LABEL | jq -r '.color')
            LABEL_DESCRIPTION=$(echo $LABEL | jq -r '.description')

            # 檢查標籤是否存在
            response=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/labels/$LABEL_NAME)

            if [ "$response" -eq 200 ]; then
              echo "Label '$LABEL_NAME' exists, updating..."
              # 更新標籤
              curl -X PATCH \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -d '{"color": "'"$LABEL_COLOR"'", "description": "'"$LABEL_DESCRIPTION"'"}' \
                https://api.github.com/repos/${{ github.repository }}/labels/$LABEL_NAME
            elif [ "$response" -eq 404 ]; then
              echo "Label '$LABEL_NAME' does not exist, creating..."
              # 創建標籤
              curl -X POST \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -d "$LABEL" \
                https://api.github.com/repos/${{ github.repository }}/labels
            else
              echo "Error: Unexpected response $response for label '$LABEL_NAME'"
            fi
          done
