name: æ–°å¢æˆ–æ›´æ–° Labels

on:
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write
  issues: write

jobs:
  add-labels:
    runs-on: ubuntu-latest
    steps:
      - name: ä½¿ç”¨ GitHub API æ–°å¢æˆ–æ›´æ–° Labels
        run: |
          LABELS=$(cat << 'EOF'
            [
              {"name": "bug", "color": "d73a4a", "description": "Something isn\'t working"},
              {"name": "documentation", "color": "0075ca", "description": "Improvements or additions to documentation"},
              {"name": "duplicate", "color": "cfd3d7", "description": "This issue or pull request already exists"},
              {"name": "enhancement", "color": "a2eeef", "description": "Feature or improvement to enhance functionality"},
              {"name": "feature", "color": "dac387", "description": "New Feature Request"},
              {"name": "good first issue", "color": "7057ff", "description": "Good for newcomers"},
              {"name": "help wanted", "color": "008672", "description": "Extra attention is needed"},
              {"name": "invalid", "color": "e4e669", "description": "This doesn\'t seem right"},
              {"name": "question", "color": "d876e3", "description": "Further information is requested"},
              {"name": "testing", "color": "f9d0c4", "description": "Marks features for testing"},
              {"name": "wip", "color": "f4a261", "description": "Work in Progress"},
              {"name": "wontfix", "color": "ffffff", "description": "This will not be worked on"}
            ]
          EOF
          )

          echo "======= Adding or updating labels to ${{ github.repository }} ======="

          for LABEL in $(echo "$LABELS" | jq -r '.[]); do
            _jq() {
              echo ${LABEL} | jq -r "${1}"
            }
            
            LABEL_NAME=$(_jq '.name')
            LABEL_COLOR=$(_jq '.color')
            LABEL_DESCRIPTION=$(_jq '.description')
            # å°‡æ¨™ç±¤åç¨±ç·¨ç¢¼ç‚º URL å®‰å…¨çš„æ ¼å¼
            LABEL_NAME=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$LABEL_NAME'))")
            
            echo "ğŸ” Checking label - [${LABEL_NAME}][${LABEL_COLOR}][${LABEL_DESCRIPTION}]"
            # æª¢æŸ¥æ¨™ç±¤æ˜¯å¦å­˜åœ¨
            response=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/labels/$LABEL_NAME)

            if [ "$response" -eq 200 ]; then
              echo "ğŸ”„ Label '$LABEL_NAME' exists, updating..."
              # æ›´æ–°æ¨™ç±¤
              curl -X PATCH \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -d '{"color": "'"$LABEL_COLOR"'", "description": "'"$LABEL_DESCRIPTION"'"}' \
                https://api.github.com/repos/${{ github.repository }}/labels/$LABEL_NAME
            elif [ "$response" -eq 404 ]; then
              echo "ğŸ› ï¸ Label '$LABEL_NAME' does not exist, creating..."
              # å‰µå»ºæ¨™ç±¤
              curl -X POST \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -d "$LABEL" \
                https://api.github.com/repos/${{ github.repository }}/labels
            else
              echo "ğŸ›‘ Error: Unexpected response $response for label '$LABEL_NAME'"
            fi
          done
