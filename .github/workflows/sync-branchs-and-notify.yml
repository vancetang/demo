name: Auto Sync Branchs & Notify

on:
  push:
    branches:
      - master # ç•¶ master åˆ†æ”¯æœ‰æ›´æ–°æ™‚è§¸ç™¼
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions: write-all

jobs:
  sync-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç¢ºä¿å¯ä»¥å–å¾—å®Œæ•´çš„ Git ç´€éŒ„ï¼Œé¿å… Merge å•é¡Œ

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Auto Merge Master into Branches
        env:
          BRANCHES: "develop" # éœ€åŒæ­¥çš„åˆ†æ”¯æ¸…å–®
        run: |
          for branch in $BRANCHES; do
            echo "Merging master into $branch"
            git checkout $branch
            if git merge origin/master --no-edit; then
              echo "âœ… $branch is up-to-date with master"
              git push origin $branch
            else
              echo "âŒ Merge conflict detected in $branch"
              echo "- Branch $branch has conflicts with master." >> conflicts.txt
              git merge --abort
            fi
          done

      - name: Send Notification if Conflicts Detected
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        if: always() # ç¢ºä¿å³ä½¿ merge æˆåŠŸï¼Œä»ç„¶æœƒåŸ·è¡Œé€™æ­¥é©Ÿ
        run: |
          if [ -f conflicts.txt ]; then
            echo "ğŸ“¢ Sending conflict notifications..."
            gh issue create --title "Merge Conflict Detected" \
                            --body "$(cat conflicts.txt)" \
                            --assignee $OWNER || echo "âš ï¸ Failed to create GitHub Issue"
          else
            echo "âœ… No merge conflicts detected."
          fi
