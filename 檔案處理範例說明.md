# CompletableFutureThreadPool 檔案處理範例

## 概述

這個範例展示如何使用 `CompletableFutureThreadPool.executeTasks` 方法來並行處理資料夾中的 .txt 檔案。範例包含兩個測試方法，從基本的檔案處理到進階的策略型處理。

## 範例 1：基本檔案處理 (`testProcessTxtFiles`)

### 功能特點
- 掃描指定資料夾下的所有 .txt 檔案
- 為每個檔案建立一個 `Runnable` 處理任務
- 使用 `CompletableFutureThreadPool.executeTasks` 並行執行
- 模擬耗時的檔案處理操作
- 將處理結果儲存為新檔案

### 核心程式碼結構

```java
@Test
public void testProcessTxtFiles() {
    String folderPath = "test-data";
    
    // 1. 建立測試檔案
    createTestTxtFiles(folderPath);
    
    // 2. 掃描並建立處理任務
    List<Runnable> txtProcessingTasks = createTxtProcessingTasks(folderPath);
    
    // 3. 並行執行所有任務
    CompletableFutureThreadPool.executeTasks("TXT_PROCESSOR", 
        txtProcessingTasks.toArray(new Runnable[0]));
}
```

### 關鍵方法說明

#### `createTxtProcessingTasks(String folderPath)`
- 使用 `Files.walk()` 遞迴掃描資料夾
- 過濾出 .txt 檔案
- 為每個檔案建立 `Runnable` 任務

#### `createFileProcessingTask(Path filePath)`
- 封裝單一檔案的處理邏輯
- 讀取檔案內容
- 執行耗時處理操作
- 儲存處理結果

## 範例 2：進階檔案處理 (`testAdvancedFileProcessing`)

### 功能特點
- 根據檔案名稱和內容自動選擇處理策略
- 支援多種處理策略：文字分析、資料處理、日誌解析、配置驗證
- 詳細的處理結果統計
- 更真實的業務場景模擬

### 處理策略

| 策略 | 觸發條件 | 處理內容 | 耗時 |
|------|----------|----------|------|
| `CONFIG_VALIDATION` | 檔名包含 "config" | 驗證配置格式 | 1秒 |
| `DATA_PROCESSING` | 檔名包含 "data" | CSV 資料處理 | 2秒 |
| `LOG_PARSING` | 檔名包含 "log" | 日誌統計分析 | 1.5秒 |
| `TEXT_ANALYSIS` | 檔名包含 "large" 或行數>20 | 文字統計分析 | 3秒 |
| `GENERAL_PROCESSING` | 其他情況 | 一般格式化處理 | 2秒 |

### 核心程式碼結構

```java
private Runnable createAdvancedFileProcessingTask(Path filePath) {
    return () -> {
        // 1. 讀取檔案內容
        List<String> lines = Files.readAllLines(filePath);
        
        // 2. 決定處理策略
        ProcessingStrategy strategy = determineProcessingStrategy(fileName, lines);
        
        // 3. 執行對應處理邏輯
        ProcessingResult result = executeProcessingStrategy(fileName, lines, strategy);
        
        // 4. 儲存處理結果
        saveAdvancedProcessingResult(filePath, result);
    };
}
```

## 實際應用場景

### 1. 文件批次處理
```java
// 處理合約文件
List<Runnable> contractTasks = createContractProcessingTasks("contracts/");
CompletableFutureThreadPool.executeTasks("CONTRACT_PROCESSOR", 
    contractTasks.toArray(new Runnable[0]));
```

### 2. 日誌分析
```java
// 分析系統日誌
List<Runnable> logTasks = createLogAnalysisTasks("logs/");
CompletableFutureThreadPool.executeTasks("LOG_ANALYZER", 
    logTasks.toArray(new Runnable[0]));
```

### 3. 資料轉換
```java
// CSV 資料轉換
List<Runnable> dataTasks = createDataTransformTasks("data/");
CompletableFutureThreadPool.executeTasks("DATA_TRANSFORMER", 
    dataTasks.toArray(new Runnable[0]));
```

## 關鍵設計模式

### 1. 任務工廠模式
將檔案處理邏輯封裝成 `Runnable`，便於並行執行：

```java
private Runnable createFileProcessingTask(Path filePath) {
    return () -> {
        // 處理邏輯
        processFile(filePath);
    };
}
```

### 2. 策略模式
根據檔案類型選擇不同的處理策略：

```java
private ProcessingStrategy determineProcessingStrategy(String fileName, List<String> lines) {
    if (fileName.contains("config")) return CONFIG_VALIDATION;
    if (fileName.contains("data")) return DATA_PROCESSING;
    // ... 其他策略
}
```

### 3. 結果封裝模式
使用 `ProcessingResult` 類別封裝處理結果：

```java
public class ProcessingResult {
    private final String fileName;
    private final ProcessingStrategy strategy;
    private final long processingTime;
    // ... 其他屬性
}
```

## 執行結果

### 基本範例執行結果
```
找到 4 個 .txt 檔案，開始並行處理
[Task-0-TXT_PROCESSOR-0] 開始處理檔案: document.txt
[Task-1-TXT_PROCESSOR-1] 開始處理檔案: file1.txt
所有 .txt 檔案處理完成
```

### 進階範例執行結果
```
準備處理 6 個檔案，使用進階處理邏輯
檔案 config.txt 處理完成，策略: CONFIG_VALIDATION, 耗時: 1005 毫秒
檔案 data.txt 處理完成，策略: DATA_PROCESSING, 耗時: 2005 毫秒
檔案 log.txt 處理完成，策略: LOG_PARSING, 耗時: 1508 毫秒
進階檔案處理完成，總耗時: 6048 毫秒
```

## 效能優勢

1. **並行處理**：多個檔案同時處理，大幅縮短總處理時間
2. **線程池管理**：使用固定大小的線程池，避免線程過度創建
3. **資源控制**：透過線程池限制並發數量，防止系統資源耗盡
4. **錯誤隔離**：單一檔案處理失敗不影響其他檔案

## 使用建議

1. **檔案數量**：適合處理大量小到中等大小的檔案
2. **處理時間**：每個檔案的處理時間應該相對均勻
3. **記憶體使用**：注意檔案內容載入記憶體的總量
4. **錯誤處理**：在 `Runnable` 中妥善處理異常
5. **結果收集**：如需收集處理結果，考慮使用 `executeSuppliers` 方法

## 執行測試

```bash
# 執行基本檔案處理測試
mvn test -Dtest=CompletableFutureThreadPoolTest#testProcessTxtFiles

# 執行進階檔案處理測試
mvn test -Dtest=CompletableFutureThreadPoolTest#testAdvancedFileProcessing
```
